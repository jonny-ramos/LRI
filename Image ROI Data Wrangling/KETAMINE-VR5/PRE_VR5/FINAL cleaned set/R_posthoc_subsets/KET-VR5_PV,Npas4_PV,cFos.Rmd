---
title: "KET_VR5_posthoc_part3: PV/Npas4+/cFos- vs PV/cFos+/Npas4-"
author: "Jonathan Ramos"
date: "2024-04-11"
output: pdf_document
---

```{r}
library(ggplot2)
library(ggpubr)
library(car)
library(emmeans)
library(stringr)
```

# Slicing out PV populations based on cFos/Npas4
In this markdown file I will slice out two (or possibly 4) populations of PV cells

  * PV/Npas4+/cFos-
  * PV/Npas4-/cFos+

as well as

  * PV/Npas4+/cFos-/WFA+
  * PV/Npas4+/cFos-/WFA-
  * PV/Npas4-/cFos+/WFA+
  * PV/Npas4-/cFos+/WFA-

and then address whether or not the interaction between treatment by treatment depends on the level of these population levels. 

Overall there were no interesting interactions to suggest that PV intensity differs between cFos+/Npas4- and Npas4+/cFos- populations, whether we take into account the presence of a PNN or not. 

```{r}
##### reusing some function definitions for convenience
Sidak <- function(pvals)
  # takes a vector of p-values and corrects p-values according to 
  # Sidaks method for multiple comparisons (1967)
  #
  # Jonathan Ramos 3/12/2024
  {
  adjusted <- c()
  j <- length(pvals)
  
  for (i in 1:j){
    adj_p <- 1-(1-pvals[i])^j
    adjusted <- c(adjusted, adj_p)
  }
  return(adjusted)
}

eda_anova <- function(df, qual=TRUE, quant=TRUE)
  # takes a filname, loads data from csv; data 4 columns:
  # react_treat, react, treat, and norm_int (response var)
  # react_treat is just react and treat in one string separated by "_"
  # builds factor cols for categorical cols (norm_int is numeric, all others are categorical)
  # then performs the following tasks:
  # checks assumptions of normality with qqplot and shapiro wilk tests
  # checks assumptions of equal variances with box plot and levene test
  # performs 2way ANOVA (2 by 2, react by treat)
  # performs post hoc pairwise comparisons (emmeans of levels of react by treat
  # and emmeans of levels of treat by react)
  # prints out all statistical test results and returns plot objects
  # for the two plots: the qqplots and the box plots
  # 
  # Jonathan Ramos 3/12/2024

  {
  ### check assumption of normality
  # quantitative assessment
  if (quant) {
    print(tapply(df$norm_adjusted_intensity, df$react_treat_factor, shapiro.test))
  }
  
  # qualitative assessment
  if (qual) {
    g <- ggqqplot(df, x="norm_adjusted_intensity", facet.by=c("treat_factor", "react_factor"))
  }
  
  
  ### check assumption of equal variances
  # quantitative assessment
  if (quant) {
    print(leveneTest(y = df$norm_adjusted_intensity, group=df$react_treat_factor, center='mean'))
  }
  
  # qualitative assessment
  if (qual) {
    f <- ggplot(df, aes(x=treat_factor, y=norm_adjusted_intensity)) + geom_boxplot(aes(fill=treat_factor), alpha=0.5) + 
      #geom_dotplot(binaxis = "y", stackdir = "center", dotsize=0.5) +
      facet_wrap(~react_factor) +
      theme(axis.text.x = element_text(angle = 45, vjust = 1, hjust=1))
  }

  
  # run the ANOVA, display summary
  df.lm <- lm(norm_adjusted_intensity ~ treat_factor + react_factor + treat_factor*react_factor, contrasts=list(treat_factor='contr.sum', react_factor ='contr.sum'), data=df)
  df.III.aov <- car::Anova(df.lm, type = 3)
  print(df.III.aov)
  
  # post hoc pairwise comparisons
  emm <- emmeans(df.lm, ~ treat_factor * react_factor)
  p1 <- pairs(emm, simple="treat_factor", adjust="tukey")
  p2 <- pairs(emm, simple="react_factor", adjust="tukey")
  
  # add col to summary dataframe containing sidak adjusted p-values
  adjusted_p.value1 <- Sidak(summary(p1, adjust="tukey")$p.value)
  s1 <- summary(p1)
  s1['adjusted_p.value'] <- adjusted_p.value1
  
  adjusted_p.value2 <- Sidak(summary(p2, adjust="tukey")$p.value)
  s2 <- summary(p2)
  s2['adjusted_p.value'] <- adjusted_p.value2
  
  # display results
  print(s1)
  print(s2)
  
  if (qual) {
    return(list(g, f))
  }
}
```

# Different populations of PVs? Comparing PV/Npas4+/cFos- and PV/cFos+/Npas4- Intensities
### PV/Npas4+/cFos-
First I will perform a reactivation x treatment x dummy_cFos (2 x 2 x 2) 3way ANOVA in PV/Npas4+ cells. That is, does the interaction between reactivation and treatment in PV/Npas4+ cells depend on whether or not there was also cFos? NO.

Nothing too interesting in this 2way ANOVA but it may be the case that we need to further split out the population of PVs with vs without PNNs. 

```{r}
# we can just load in our split quartile sets as double-labeled PV and just not
# consider the quartile labels

# PV/Npas4+
PV.Npas4 <- read.csv('KET-VR5_PV_split_on_Npas4_NORM.csv')
PV.Npas4$react_factor <- as.factor(PV.Npas4$react)
PV.Npas4$treat_factor <- as.factor(PV.Npas4$treat)
PV.Npas4$react_treat_factor <- as.factor(PV.Npas4$treatment)
PV.Npas4$dummy_WFA_factor <- as.factor(PV.Npas4$dummy_WFA)
PV.Npas4$dummy_cFos_factor <- as.factor(PV.Npas4$dummy_cFos)

# slicing out cFos+/-
PV.Npas4.cFosp <- PV.Npas4[PV.Npas4$dummy_cFos == 'True',]
PV.Npas4.cFosm <- PV.Npas4[PV.Npas4$dummy_cFos == 'False',]

### additionally slicing out WFA+/-
PV.Npas4.cFosm.WFAp <- PV.Npas4.cFosm[PV.Npas4.cFosm$dummy_WFA == 'True',]
PV.Npas4.cFosm.WFAm <- PV.Npas4.cFosm[PV.Npas4.cFosm$dummy_WFA == 'False',]

# 3way ANOVA: reactivation x treatment x dummy_cFos (2 x 2 x 2) in PV/Npas4+ cells
### that is: does the interaction between reactivation and treatment in PV/Npas4+ cells depend on whether or not there was also cFos? NO.
PV.Npas4.lm <- lm(norm_adjusted_intensity ~ treat_factor*react_factor*dummy_cFos_factor, contrasts = list(treat_factor='contr.sum', react_factor='contr.sum', dummy_cFos_factor='contr.sum'), data=PV.Npas4)
PV.Npas4.aov <- car::Anova(PV.Npas4.lm, type=3)
print(PV.Npas4.aov)

# just to be sure that we really don't get anything
eda_anova(PV.Npas4.cFosm, quant=FALSE, qual=FALSE)

```

### PV/cFos/Npas-

Next I will do the same but in PV cells with cFos but NOT Npas4. That is, I will perform a reactivation x treatment x dummy_Npas4 (2 x 2 x 2) 3way ANOVA in PV/cFos+ cells to address the question: does the interaction between reactivation and treatment in PV/cFos+ cells depend on whether or not there was also Npas4? NO.

Nothing too interesting in this 2way ANOVA either but it may be the case that we need to further split out the population of PVs with vs without PNNs. 

```{r}
# PV/cFos+
PV.cFos <- read.csv('KET-VR5_PV_split_on_cFos_NORM.csv')
PV.cFos$react_factor <- as.factor(PV.cFos$react)
PV.cFos$treat_factor <- as.factor(PV.cFos$treat)
PV.cFos$react_treat_factor <- as.factor(PV.cFos$treatment)
PV.cFos$dummy_WFA_factor <- as.factor(PV.cFos$dummy_WFA)
PV.cFos$dummy_Npas4_factor <- as.factor(PV.cFos$dummy_Npas4)

# slicing out Npas4+/-
PV.cFos.Npas4p <- PV.cFos[PV.cFos$dummy_Npas4 == 'True',]
PV.cFos.Npas4m <- PV.cFos[PV.cFos$dummy_Npas4 == 'False',]

### additionally slicing out WFA+/-
PV.cFos.Npas4m.WFAp <- PV.cFos.Npas4m[PV.cFos.Npas4m$dummy_WFA == 'True',]
PV.cFos.Npas4m.WFAm <- PV.cFos.Npas4m[PV.cFos.Npas4m$dummy_WFA == 'False',]

# 3way ANOVA: reactivation x treatment x dummy_Npas4 (2 x 2 x 2) in PV/cFos+ cells
PV.cFos.lm <- lm(norm_adjusted_intensity ~ treat_factor*react_factor*dummy_Npas4_factor, contrasts = list(treat_factor='contr.sum', react_factor='contr.sum', dummy_Npas4_factor='contr.sum'), data=PV.cFos)
PV.cFos.aov <- car::Anova(PV.cFos.lm, type=3)
print(PV.cFos.aov) 

# just to be sure really don't get anything
eda_anova(PV.Npas4.cFosm, quant=FALSE, qual=FALSE)
```

### ONE last thing just to be sure: reactivation by treatment by ensemble 3way ANOVA
This 3way ANOVA does not indicate that there is a significant 3way interaction between reactivation, treatment and ensemble (either PV/Npas4-/cFos+ OR PV/Npas+/cFos-), as expected (since I started essentially the post hoc 2ways)

```{r}
library(tidyverse)
PV.cFos.Npas4m$ensemble <- 'Npas4'
PV.Npas4.cFosm$ensemble <- 'cFos'

PV.cFos.Npas4m.ensemble <- PV.cFos.Npas4m[c('norm_adjusted_intensity', 'react_factor', 'treat_factor', 'react_treat_factor', 'dummy_WFA_factor', 'ensemble')]
PV.Npas4.cFosm.ensemble <- PV.Npas4.cFosm[c('norm_adjusted_intensity', 'react_factor', 'treat_factor', 'react_treat_factor', 'dummy_WFA_factor', 'ensemble')]

PV.ensemble <- bind_rows(PV.cFos.Npas4m.ensemble, PV.Npas4.cFosm.ensemble)
PV.ensemble$ensemble_factor <- as.factor(PV.ensemble$ensemble)

# 3way ANOVA: reactivation x treatment x ensemble (2 x 2 x 2) in PV cells
PV.ensemble.lm <- lm(norm_adjusted_intensity ~ treat_factor*react_factor*ensemble_factor, contrasts = list(treat_factor='contr.sum', react_factor='contr.sum', ensemble_factor='contr.sum'), data=PV.ensemble)
PV.ensemble.aov <- car::Anova(PV.ensemble.lm, type=3)
print(PV.ensemble.aov) 
```

# Testing PV/Npas4+/cFos- and PV/cFos+/Npas4- with or without PNNs
### PV/Npas4+/cFos- with or without PNNs
Here I show a reactivation x treatment x WFA (2 x 2 x 2) 3way ANOVA to address whether or not the interaction between treatment and reactivation in PV cells with Npas4 but NOT cFos depends on presence of PNNs. (NO)

Nothing interesting here even if we consider the presence of PNNs in PV/Npas4+/cFos- cells.

```{r}
# 3way ANOVA: reactivation x treatment x dummy_WFA (2 x 2 x 2) in PV cells with Npas4 but NOT cFos
PV.Npas4.cFosm.ensemble.lm <- lm(norm_adjusted_intensity ~ treat_factor*react_factor*dummy_WFA_factor, contrasts = list(treat_factor='contr.sum', react_factor='contr.sum', dummy_WFA_factor='contr.sum'), data=PV.Npas4.cFosm.ensemble)
PV.Npas4.cFosm.ensemble.aov <- car::Anova(PV.Npas4.cFosm.ensemble.lm, type=3)
print(PV.Npas4.cFosm.ensemble.aov) 
```


### PV/cFos+/Npas4- with or without PNNs
Here I show a reactivation x treatment x WFA (2 x 2 x 2) 3way ANOVA to address whether or not the interaction between treatment and reactivation in PV cells with cFos but NOT Npas4 depends on presence of PNNs. (NO)

Nothing interesting here even if we consider the presence of PNNs in PV/cFos+/Npas4- cells.

```{r}
# 3way ANOVA: reactivation x treatment x ensemble (2 x 2 x 2) in PV cells
PV.cFos.Npas4m.ensemble.lm <- lm(norm_adjusted_intensity ~ treat_factor*react_factor*dummy_WFA_factor, contrasts = list(treat_factor='contr.sum', react_factor='contr.sum', dummy_WFA_factor='contr.sum'), data=PV.cFos.Npas4m.ensemble)
PV.cFos.Npas4m.ensemble.aov <- car::Anova(PV.cFos.Npas4m.ensemble.lm, type=3)
print(PV.cFos.Npas4m.ensemble.aov) 
```

# Low intensity Npas4
### (2way treatment x reactivation interaction only at the 3rd quartile of Npas4 intensity)

Previously, the 4way and 3way ANOVAs from the linear models for PV intensity explained by treatment, reactivation, Npas4 quartile, and dummy_WFA suggested that one of the lower 3 quartiles, not the highest quartile of Npas4 intensity might be important for investigating the interaction effect between treatment and reactivation.

First a perform a treatment by reactivation by quartile by dummy_WFA (2 x 2 x 4 x 2) 4way ANOVA to determine if a 3way interaction between reactivation, treatment and quartile depends on the presence of PNNs. The 4way interaction is not significant and so I remove the dummy_WFA categorical variable from the linear model and rebuild a reduced 3way model.

Since the 4way interaction didn't come out, I drop dummy_WFA from the linear model and perform a treatment by reactivation by quartile (2 x 2 x 4) 3way ANOVA to assess whether the 2way interaction between treatment and reactivation depends on the quartile of Npas4 intensity.

Here we do see a significant 3way interaction (F=4.7978, p=0.002634) and so I follow up with a series of treatment by reactivation (2 x 2) 2way ANOVAs at each level of Npas4 quartile (4 labels). We only see a significant treatment by reactivation interaction effect at the level of the THIRD Npas4 quartile (F=15.9981, p=0.0001074). The post hoc multiple comparisons for this 2way ANOVA show that PV intensity is reduced in the VR5_KET condition compared to both the VR5_SAL condition (t=-2.598, p=0.02085) and FR1_KET condition (t=3.561, p=0.00104). 


```{r}
PV.Npas4$lowest.q <- PV.Npas4$quartile == 'q1'
PV.Npas4$lowestq_factor <- as.factor(PV.Npas4$lowest.q)
PV.Npas4$quartile_factor <- as.factor(PV.Npas4$quartile)

# taking into account the presence of PNNs
PV.Npas4.lm <- lm(norm_adjusted_intensity ~ treat_factor*react_factor*quartile_factor*dummy_WFA_factor, contrasts = list(treat_factor='contr.sum', react_factor='contr.sum', quartile_factor='contr.sum', dummy_WFA_factor='contr.sum'), data=PV.Npas4)
PV.Npas4.aov <- car::Anova(PV.Npas4.lm, type=3)
print(PV.Npas4.aov)

# ignoring the presence of PNNs
PV.Npas4.lm <- lm(norm_adjusted_intensity ~ treat_factor*react_factor*quartile_factor, contrasts = list(treat_factor='contr.sum', react_factor='contr.sum', quartile_factor='contr.sum'), data=PV.Npas4)
PV.Npas4.aov <- car::Anova(PV.Npas4.lm, type=3)
print(PV.Npas4.aov)


print('treat by react 2way ANOVA, first quartile Npas4 intensity')
PV.Npas4.q1 <- PV.Npas4[PV.Npas4$quartile == 'q1',]
eda_anova(PV.Npas4.q1, quant = FALSE)

print('treat by react 2way ANOVA, second quartile Npas4 intensity')
PV.Npas4.q2 <- PV.Npas4[PV.Npas4$quartile == 'q2',]
eda_anova(PV.Npas4.q2, quant = FALSE)

print('treat by react 2way ANOVA, third quartile Npas4 intensity')
PV.Npas4.q3 <- PV.Npas4[PV.Npas4$quartile == 'q3',]
eda_anova(PV.Npas4.q3, quant = FALSE)

print('treat by react 2way ANOVA, fourth quartile Npas4 intensity')
PV.Npas4.q4 <- PV.Npas4[PV.Npas4$quartile == 'q4',]
eda_anova(PV.Npas4.q4, quant = FALSE)
  
```


# Following up on Npas4 with PV+/- 3way ANOVA
With only main effects of reactivation, treatment and dummy_PV, there is no need for further decomposition into 2way ANOVAs.

From the post hoc t-test below, we can see that we have t=3.0241 and p=0.002566, and so we may conclude that Npas4 intensity is higher in Npas4 cells that also had PV than Npas4 cells without PV. 

```{r}
Npas4 <- read.csv('NORM_single_WFA.csv', header=TRUE, sep=',')
Npas4$dummy_PV_factor <- as.factor(Npas4$dummy_PV)
split <- str_split_fixed(Npas4$treatment, "_", 2)
Npas4$react <- split[,1]
Npas4$treat <- split[,2]
Npas4$react_factor <- as.factor(Npas4$react)
Npas4$treat_factor <- as.factor(Npas4$treat)

# reactivation by treatment by dummy_PV (2 x 2 x 2) 3way ANOVA
Npas4.lm <- lm(norm_intensity ~ react_factor*treat_factor*dummy_PV_factor, contrasts=list(react_factor='contr.sum', treat_factor='contr.sum', dummy_PV_factor='contr.sum'), data=Npas4)
Npas4.aov <- car::Anova(Npas4.lm, type=3)
print(Npas4.aov)

# Investigating main effects only
Npas4_with_PV <- Npas4[Npas4$dummy_PV == 'True', 'norm_intensity']
Npas4_without_PV <- Npas4[Npas4$dummy_PV == 'False', 'norm_intensity']
t.test(Npas4_with_PV, Npas4_without_PV)
```
